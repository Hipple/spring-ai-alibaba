name: Sync jmanus branch

on:
  push:
    branches: [ main ]
    paths: [ 'spring-ai-alibaba-jmanus/**' ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-jmanus:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: Check if jmanus folder exists
      run: |
        if [ ! -d "spring-ai-alibaba-jmanus" ]; then
          echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° spring-ai-alibaba-jmanus ç›®å½•"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ° spring-ai-alibaba-jmanus ç›®å½•"
    
    - name: Sync to jmanus branch
      run: |
        # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ jmanus åˆ†æ”¯
        if git show-ref --verify --quiet refs/remotes/origin/jmanus; then
          echo "ğŸ“‹ jmanus åˆ†æ”¯å·²å­˜åœ¨ï¼Œæ­£åœ¨æ›´æ–°..."
          # å…ˆå°è¯• subtree pullï¼ˆå¦‚æœ jmanus åˆ†æ”¯æœ‰ç‹¬ç«‹æäº¤ï¼‰
          git subtree pull --prefix=spring-ai-alibaba-jmanus origin jmanus --strategy=subtree -X theirs -m "åˆå¹¶ jmanus åˆ†æ”¯æ›´æ–°" || {
            echo "âš ï¸  æ‹‰å–å¤±è´¥ï¼Œè¿™å¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œ subtree æ“ä½œ"
          }
        else
          echo "ğŸ†• æ­£åœ¨åˆ›å»ºæ–°çš„ jmanus åˆ†æ”¯..."
        fi
        
        # æ¨é€æ›´æ–°åˆ° jmanus åˆ†æ”¯
        git subtree push --prefix=spring-ai-alibaba-jmanus origin jmanus
    
    - name: Verify sync result
      run: |
        git fetch origin jmanus
        git checkout jmanus
        echo "âœ… jmanus åˆ†æ”¯åŒæ­¥æˆåŠŸ"
        echo "ğŸ“ æœ€æ–°æäº¤ï¼š$(git log --oneline -1)"